<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>db.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../cryptobox.html">cryptobox.rb</a>
          <a class="source" href="config.html">config.rb</a>
          <a class="source" href="db.html">db.rb</a>
          <a class="source" href="editor.html">editor.rb</a>
          <a class="source" href="lang.html">lang.rb</a>
          <a class="source" href="template.html">template.rb</a>
          <a class="source" href="util.html">util.rb</a>
          <a class="source" href="../../templates/cipher.js.html">cipher.js.coffee</a>
          <a class="source" href="../../templates/cryptobox.js.html">cryptobox.js.coffee</a>
          <a class="source" href="../../templates/lock.js.html">lock.js.coffee</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>db.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;openssl&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;base64&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;securerandom&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;fileutils&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;date&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;io/console&#39;</span>

<span class="k">module</span> <span class="nn">Cryptobox</span>
  <span class="k">class</span> <span class="nc">Db</span>
    <span class="no">FORMAT_VERSION</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="no">PBKDF2_SALT_LEN</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="no">PBKDF2_ITERATIONS</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="no">AES_KEY_LEN</span> <span class="o">=</span> <span class="mi">128</span>

    <span class="kp">attr_accessor</span> <span class="ss">:plaintext</span>
    <span class="kp">attr_reader</span> <span class="ss">:pbkdf2_salt</span><span class="p">,</span> <span class="ss">:pbkdf2_iter</span><span class="p">,</span> <span class="ss">:aes_iv</span><span class="p">,</span> <span class="ss">:aes_keylen</span>

    <span class="kp">public</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>@db<em>path - path to cryptobox database
@backup</em>path - use given path as backup directory</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">,</span> <span class="n">keep_backups</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
      <span class="vi">@db_path</span> <span class="o">=</span> <span class="n">db_path</span>
      <span class="vi">@backup_path</span> <span class="o">=</span> <span class="n">backup_path</span>
      <span class="vi">@keep_backups</span> <span class="o">=</span> <span class="n">keep_backups</span>
      <span class="vi">@password</span> <span class="o">=</span> <span class="n">password</span>

      <span class="no">File</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mo">0077</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Create empty database, ask user to confirm if it already exists</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">password2</span><span class="p">)</span>
      <span class="k">raise</span> <span class="s2">&quot;Passwords don&#39;t match!&quot;</span> <span class="k">if</span> <span class="vi">@password</span> <span class="o">!=</span> <span class="n">password2</span>

      <span class="n">dirname</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span> <span class="vi">@db_path</span>
      <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span> <span class="n">dirname</span> <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exist?</span> <span class="n">dirname</span>

      <span class="vi">@aes_keylen</span> <span class="o">=</span> <span class="no">AES_KEY_LEN</span>
      <span class="vi">@pbkdf2_iter</span> <span class="o">=</span> <span class="no">PBKDF2_ITERATIONS</span>

      <span class="n">generate_cipher_params</span>
      <span class="n">derive_key</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Load database from @db_path</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">load</span>
      <span class="n">db</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">::</span><span class="nb">load</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="vi">@db_path</span><span class="p">))</span>

      <span class="vi">@pbkdf2_salt</span> <span class="o">=</span> <span class="n">from_base64</span> <span class="n">db</span><span class="o">[</span><span class="s1">&#39;pbkdf2_salt&#39;</span><span class="o">]</span>
      <span class="vi">@pbkdf2_iter</span> <span class="o">=</span> <span class="n">db</span><span class="o">[</span><span class="s1">&#39;pbkdf2_iter&#39;</span><span class="o">].</span><span class="n">to_i</span>
      <span class="vi">@aes_iv</span> <span class="o">=</span> <span class="n">from_base64</span> <span class="n">db</span><span class="o">[</span><span class="s1">&#39;aes_iv&#39;</span><span class="o">]</span>
      <span class="vi">@aes_keylen</span> <span class="o">=</span> <span class="n">db</span><span class="o">[</span><span class="s1">&#39;aes_keylen&#39;</span><span class="o">].</span><span class="n">to_i</span>
      <span class="vi">@ciphertext</span> <span class="o">=</span> <span class="n">from_base64</span> <span class="n">db</span><span class="o">[</span><span class="s1">&#39;ciphertext&#39;</span><span class="o">]</span>

      <span class="k">raise</span> <span class="s1">&#39;Unsupported format version&#39;</span> <span class="k">if</span> <span class="n">db</span><span class="o">[</span><span class="s1">&#39;format_version&#39;</span><span class="o">]</span> <span class="o">!=</span> <span class="no">FORMAT_VERSION</span>

      <span class="n">derive_key</span>

      <span class="vi">@plaintext</span> <span class="o">=</span> <span class="n">decrypt</span> <span class="vi">@ciphertext</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Save database to @db_path</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">save</span>
      <span class="n">backup</span>

      <span class="n">generate_cipher_params</span>
      <span class="n">derive_key</span>

      <span class="vi">@ciphertext</span> <span class="o">=</span> <span class="n">encrypt</span> <span class="vi">@plaintext</span>

      <span class="n">db</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">db</span><span class="o">[</span><span class="s1">&#39;pbkdf2_salt&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">to_base64</span><span class="p">(</span><span class="vi">@pbkdf2_salt</span><span class="p">)</span>
      <span class="n">db</span><span class="o">[</span><span class="s1">&#39;pbkdf2_iter&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@pbkdf2_iter</span>
      <span class="n">db</span><span class="o">[</span><span class="s1">&#39;aes_iv&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">to_base64</span><span class="p">(</span><span class="vi">@aes_iv</span><span class="p">)</span>
      <span class="n">db</span><span class="o">[</span><span class="s1">&#39;aes_keylen&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@aes_keylen</span>
      <span class="n">db</span><span class="o">[</span><span class="s1">&#39;format_version&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">FORMAT_VERSION</span>
      <span class="n">db</span><span class="o">[</span><span class="s1">&#39;version&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">VERSION</span>
      <span class="n">db</span><span class="o">[</span><span class="s1">&#39;timestamp&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_s</span>
      <span class="n">db</span><span class="o">[</span><span class="s1">&#39;ciphertext&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@ciphertext</span>

      <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="vi">@db_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="no">YAML</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Ask user for password and generate new encryption key</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">change_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">password2</span><span class="p">)</span>
      <span class="k">raise</span> <span class="s2">&quot;Passwords don&#39;t match!&quot;</span> <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">password2</span>

      <span class="vi">@password</span> <span class="o">=</span> <span class="n">password</span>
      <span class="n">derive_key</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Decrypt given ciphertext</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
      <span class="n">cipher</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@aes_keylen</span><span class="p">,</span> <span class="ss">:CBC</span><span class="p">)</span>
      <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span>
      <span class="n">cipher</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="vi">@key</span>
      <span class="n">cipher</span><span class="o">.</span><span class="n">iv</span> <span class="o">=</span> <span class="vi">@aes_iv</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>try</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">return</span> <span class="n">cipher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span> <span class="o">+</span> <span class="n">cipher</span><span class="o">.</span><span class="n">final</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>catch => Invalid password</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Encrypt given plaintext</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
      <span class="n">cipher</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@aes_keylen</span><span class="p">,</span> <span class="ss">:CBC</span><span class="p">)</span>
      <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span>
      <span class="n">cipher</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="vi">@key</span>
      <span class="n">cipher</span><span class="o">.</span><span class="n">iv</span> <span class="o">=</span> <span class="vi">@aes_iv</span>

      <span class="k">return</span> <span class="n">to_base64</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span> <span class="o">+</span> <span class="n">cipher</span><span class="o">.</span><span class="n">final</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Execute block on each database entry</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">each</span>
      <span class="n">y</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">::</span><span class="nb">load</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">unless</span> <span class="n">y</span>

      <span class="n">includes</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="s1">&#39;include&#39;</span><span class="p">)</span> <span class="p">?</span> <span class="n">y</span><span class="o">[</span><span class="s1">&#39;include&#39;</span><span class="o">]</span> <span class="p">:</span> <span class="p">{}</span>

      <span class="n">y</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">type_path</span><span class="p">,</span> <span class="n">entries</span><span class="o">|</span>
        <span class="k">next</span> <span class="k">if</span> <span class="n">type_path</span> <span class="o">==</span> <span class="s1">&#39;include&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>type = type<em>path.split(File::PATH</em>SEPARATOR)[0]</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">type</span> <span class="o">=</span> <span class="n">type_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>

        <span class="n">entries</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">entry</span><span class="o">|</span>
          <span class="k">raise</span> <span class="s2">&quot;Wrong number!!!&quot;</span> <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span>

          <span class="nb">name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">keys</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>

          <span class="n">vars</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span> <span class="k">raise</span> <span class="s2">&quot;Key </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is not found!&quot;</span> <span class="p">}</span>

          <span class="n">vars</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="nb">name</span>
          <span class="n">vars</span><span class="o">[</span><span class="ss">:type_path</span><span class="o">]</span> <span class="o">=</span> <span class="n">type_path</span>
          <span class="n">vars</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">=</span> <span class="n">type</span>

          <span class="n">vars</span><span class="o">.</span><span class="n">merge!</span> <span class="n">entry</span><span class="o">[</span><span class="nb">name</span><span class="o">].</span><span class="n">symbolize_keys</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>FIXME: do this in runtime !!!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">vars</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="n">vars</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/&quot;/</span><span class="p">,</span> <span class="s1">&#39;\&quot;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">vars</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">instance_of?</span> <span class="nb">String</span> <span class="p">}</span>

          <span class="k">yield</span> <span class="n">vars</span><span class="p">,</span> <span class="n">includes</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>for each alias yield a result with different type_path</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">vars</span><span class="o">[</span><span class="ss">:alias</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">alias_type_path</span><span class="o">|</span>
            <span class="n">vars</span><span class="o">[</span><span class="ss">:type_path</span><span class="o">]</span> <span class="o">=</span> <span class="n">alias_type_path</span>

            <span class="k">yield</span> <span class="n">vars</span><span class="p">,</span> <span class="n">includes</span>
          <span class="k">end</span> <span class="k">if</span> <span class="n">vars</span><span class="o">.</span><span class="n">has_key?</span> <span class="ss">:alias</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="kp">private</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Generate default cipher parameters (salf, iv, etc)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">generate_cipher_params</span>
      <span class="vi">@aes_iv</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@aes_keylen</span><span class="p">,</span> <span class="ss">:CBC</span><span class="p">)</span><span class="o">.</span><span class="n">random_iv</span>
      <span class="vi">@pbkdf2_salt</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">random_bytes</span> <span class="no">PBKDF2_SALT_LEN</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Convert given argument to base64 encoding and strip newlines</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">to_base64</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="k">return</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Wrapper for Base64.decode64 (for consistency with to_base64)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">from_base64</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="k">return</span> <span class="no">Base64</span><span class="o">.</span><span class="n">decode64</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Backup previous version of database</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">backup</span>
      <span class="k">return</span> <span class="k">unless</span> <span class="vi">@keep_backups</span>
      <span class="k">return</span> <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span> <span class="vi">@db_path</span>
      <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span> <span class="vi">@backup_path</span> <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exist?</span> <span class="vi">@backup_path</span>
      <span class="no">FileUtils</span><span class="o">.</span><span class="n">cp</span> <span class="vi">@db_path</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="vi">@backup_path</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H_%M_%S_%d_%m_%Y&quot;</span><span class="p">))</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Get encryption key from password and store it in @key</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">derive_key</span>
      <span class="vi">@key</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKCS5</span><span class="o">::</span><span class="n">pbkdf2_hmac_sha1</span><span class="p">(</span><span class="vi">@password</span><span class="p">,</span> <span class="vi">@pbkdf2_salt</span><span class="p">,</span> <span class="vi">@pbkdf2_iter</span><span class="p">,</span> <span class="vi">@aes_keylen</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
