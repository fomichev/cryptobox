<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>editor.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../cryptobox.html">cryptobox.rb</a>
          <a class="source" href="config.html">config.rb</a>
          <a class="source" href="db.html">db.rb</a>
          <a class="source" href="editor.html">editor.rb</a>
          <a class="source" href="lang.html">lang.rb</a>
          <a class="source" href="template.html">template.rb</a>
          <a class="source" href="util.html">util.rb</a>
          <a class="source" href="../../templates/cipher.js.html">cipher.js.coffee</a>
          <a class="source" href="../../templates/cryptobox.js.html">cryptobox.js.coffee</a>
          <a class="source" href="../../templates/lock.js.html">lock.js.coffee</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>editor.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rbconfig&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;securerandom&#39;</span>

<span class="vg">$is_pipe</span> <span class="o">=</span> <span class="kp">false</span>
<span class="vg">$is_windows</span> <span class="o">=</span> <span class="p">(</span><span class="no">RbConfig</span><span class="o">::</span><span class="no">CONFIG</span><span class="o">[</span><span class="s1">&#39;host_os&#39;</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/mswin|mingw|cygwin/</span><span class="p">)</span>
<span class="vg">$text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">mkfifo</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">&quot;create fifo </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="no">File</span><span class="o">.</span><span class="n">unlink</span> <span class="nb">name</span> <span class="k">rescue</span> <span class="kp">nil</span>
  <span class="nb">system</span> <span class="s2">&quot;mkfifo -m 600 </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">open_editor</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">fifo_name</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">&quot;open editor&quot;</span>

  <span class="k">return</span> <span class="no">Thread</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">&#39;&gt;&gt;&gt;&#39;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="nb">system</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">editor</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">fifo_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">puts</span> <span class="s2">&quot;&lt;&lt;&lt; ret=</span><span class="si">#{</span><span class="n">ret</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">unless</span> <span class="n">ret</span>
      <span class="k">raise</span> <span class="s2">&quot;Couldn&#39;t run editor!&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">write_initial</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">&quot;write data&quot;</span>
  <span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">read_back</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">initial_text</span><span class="p">)</span>
  <span class="k">return</span> <span class="no">Thread</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="bp">__LINE__</span>
    <span class="kp">loop</span> <span class="k">do</span>
      <span class="nb">puts</span> <span class="bp">__LINE__</span>
      <span class="vg">$text</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">)</span>
      <span class="nb">puts</span> <span class="bp">__LINE__</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>on windows this ^^^ loops</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nb">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="k">if</span> <span class="vg">$is_windows</span>
      <span class="nb">sleep</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="nb">puts</span> <span class="bp">__LINE__</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="n">initial_text</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;__no_save__&#39;</span>
    <span class="nb">puts</span> <span class="s1">&#39;no save&#39;</span>
    <span class="k">return</span> <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="nb">puts</span> <span class="s1">&#39;save:&#39;</span>
  <span class="k">if</span> <span class="n">initial_text</span> <span class="o">==</span> <span class="n">text</span>
    <span class="nb">puts</span> <span class="s1">&#39;got the same text&#39;</span>
    <span class="k">return</span> <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="k">return</span> <span class="n">text</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>http://www.cs.auckland.ac.nz/~pgut001/pubs/secure_del.html</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">def</span> <span class="nf">override_data</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">cycle</span> <span class="k">unless</span> <span class="n">pattern</span><span class="o">.</span><span class="n">instance_of?</span> <span class="no">Proc</span>

    <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
      <span class="n">size</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">instance_of?</span> <span class="no">Proc</span>
          <span class="n">c</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">call</span>
        <span class="k">else</span>
          <span class="n">c</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">next</span>
        <span class="k">end</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="o">[</span> <span class="n">c</span> <span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="mi">4</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">random_number</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span> <span class="p">}</span>

  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x55</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0xAA</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x24</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x92</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x49</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x00</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x11</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x22</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x33</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x44</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x55</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x66</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x77</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x88</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x99</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0xAA</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0xBB</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0xCC</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0xDD</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0xEE</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0xFF</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x24</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x92</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x49</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xDB</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0x6D</span> <span class="o">]</span> <span class="p">)</span>
  <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">[</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0xB6</span> <span class="o">]</span> <span class="p">)</span>

  <span class="mi">4</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">override_with_pattern</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">random_number</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="p">}</span> <span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="n">override_data</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="nb">name</span><span class="p">))</span> <span class="k">unless</span> <span class="vg">$is_pipe</span>
  <span class="no">File</span><span class="o">.</span><span class="n">unlink</span> <span class="nb">name</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">on_signal</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
  <span class="n">t1</span><span class="o">.</span><span class="n">kill</span>
  <span class="n">t2</span><span class="o">.</span><span class="n">kill</span> <span class="k">if</span> <span class="n">t2</span>
  <span class="n">cleanup</span> <span class="nb">name</span>
  <span class="nb">exit</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">edit_fifo</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">initial_text</span><span class="p">)</span>
  <span class="n">mkfifo</span> <span class="n">fifo_name</span>
  <span class="n">editor_thread</span> <span class="o">=</span> <span class="n">open_editor</span> <span class="n">editor</span><span class="p">,</span> <span class="n">fifo_name</span>
  <span class="n">write_initial</span> <span class="n">fifo_name</span><span class="p">,</span> <span class="n">initial_text</span>
  <span class="n">readback_thread</span> <span class="o">=</span> <span class="n">read_back</span> <span class="n">fifo_name</span><span class="p">,</span> <span class="n">initial_text</span>

  <span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;INT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">on_signal</span> <span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor_thread</span><span class="p">,</span> <span class="n">readback_thread</span> <span class="p">}</span>
  <span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;ABRT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">on_signal</span> <span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor_thread</span><span class="p">,</span> <span class="n">readback_thread</span> <span class="p">}</span>
  <span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;QUIT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">on_signal</span> <span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor_thread</span><span class="p">,</span> <span class="n">readback_thread</span> <span class="p">}</span> <span class="k">unless</span> <span class="vg">$is_windows</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>wait for editor</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">editor_thread</span><span class="o">.</span><span class="n">join</span>
  <span class="n">readback_thread</span><span class="o">.</span><span class="n">join</span> <span class="mi">1</span> <span class="c1"># 1 second should be enough to read from fifo</span>
  <span class="n">readback_thread</span><span class="o">.</span><span class="n">kill</span>

  <span class="n">cleanup</span> <span class="n">fifo_name</span>

  <span class="vg">$text</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">edit_file</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">initial_text</span><span class="p">)</span>
  <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="n">initial_text</span> <span class="p">}</span>

  <span class="n">editor_thread</span> <span class="o">=</span> <span class="n">open_editor</span> <span class="n">editor</span><span class="p">,</span> <span class="n">fifo_name</span>

  <span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;INT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">on_signal</span> <span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor_thread</span><span class="p">,</span> <span class="kp">nil</span> <span class="p">}</span>
  <span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;ABRT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">on_signal</span> <span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor_thread</span><span class="p">,</span> <span class="kp">nil</span> <span class="p">}</span>
  <span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;QUIT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">on_signal</span> <span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor_thread</span><span class="p">,</span> <span class="kp">nil</span> <span class="p">}</span> <span class="k">unless</span> <span class="vg">$is_windows</span>

  <span class="n">editor_thread</span><span class="o">.</span><span class="n">join</span>

  <span class="n">text</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>TODO: rewrite file data with random pattern</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">cleanup</span> <span class="n">fifo_name</span>

  <span class="n">text</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">run_editor</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">initial_text</span><span class="p">,</span> <span class="n">use_pipe</span><span class="p">)</span>
  <span class="n">fifo_name</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="mi">65</span><span class="o">.</span><span class="n">+</span><span class="p">(</span><span class="no">SecureRandom</span><span class="o">.</span><span class="n">random_number</span><span class="p">(</span><span class="mi">25</span><span class="p">))</span><span class="o">.</span><span class="n">chr</span><span class="p">}</span><span class="o">.</span><span class="n">join</span> <span class="o">+</span> <span class="s1">&#39;.yml&#39;</span>
  <span class="n">text</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="no">Dir</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">home</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="vg">$is_windows</span> <span class="ow">or</span> <span class="n">use_pipe</span> <span class="o">==</span> <span class="kp">false</span>
      <span class="vg">$is_pipe</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="n">text</span> <span class="o">=</span> <span class="n">edit_file</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">initial_text</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="vg">$is_pipe</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="n">text</span> <span class="o">=</span> <span class="n">edit_fifo</span><span class="p">(</span><span class="n">fifo_name</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">initial_text</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">unless</span> <span class="n">text</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">done</span> <span class="n">initial_text</span><span class="p">,</span> <span class="n">text</span>
  <span class="k">end</span>

  <span class="k">return</span> <span class="n">initial_text</span> <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="kp">nil</span>
  <span class="k">return</span> <span class="n">text</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
