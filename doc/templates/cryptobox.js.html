<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>cryptobox.js.coffee</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../lib/cryptobox.html">cryptobox.rb</a>
          <a class="source" href="../lib/cryptobox/config.html">config.rb</a>
          <a class="source" href="../lib/cryptobox/db.html">db.rb</a>
          <a class="source" href="../lib/cryptobox/editor.html">editor.rb</a>
          <a class="source" href="../lib/cryptobox/lang.html">lang.rb</a>
          <a class="source" href="../lib/cryptobox/template.html">template.rb</a>
          <a class="source" href="../lib/cryptobox/util.html">util.rb</a>
          <a class="source" href="cipher.js.html">cipher.js.coffee</a>
          <a class="source" href="cryptobox.js.html">cryptobox.js.coffee</a>
          <a class="source" href="lock.js.html">lock.js.coffee</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>cryptobox.js.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Declare main namespace for cryptobox</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">window</span><span class="p">.</span><span class="nv">Cryptobox = </span><span class="p">{}</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Encrypted cryptobox.json; it's null for Dropbox version and non-null
(appended somewhere later) in <code>embedded</code> version</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">window</span><span class="p">.</span><span class="nv">Cryptobox.json = </span><span class="kc">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Simple wrapper around <code>console.log</code>; just prints <code>s</code> on console</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">window</span><span class="p">.</span><span class="nv">p = </span><span class="nf">(s) -&gt;</span>
  <span class="nx">console</span><span class="o">?</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Measure execution time given function (<code>fn</code>) and print execution time
on console with appropriate <code>name</code>. Result of the <code>fn</code> execution is returned.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">window</span><span class="p">.</span><span class="nv">Cryptobox.measure = </span><span class="nf">(name, fn) -&gt;</span>
  <span class="nv">begin = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
  <span class="nv">result = </span><span class="nx">fn</span><span class="p">()</span>
  <span class="nv">end = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>

  <span class="nx">p</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">end</span> <span class="o">-</span> <span class="nx">begin</span><span class="si">}</span><span class="s">ms&quot;</span>

  <span class="k">return</span> <span class="nx">result</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Decrypt base64 encoded <code>ciphertext</code> using given password (<code>pass</code>) and cipher
parameters: . base64 encoded PBKDF2 <code>salt</code>, number of PBKDF2 <code>iterations</code>,
AES key length (<code>keylen</code>) and AES IV (<code>iv</code>). Decrypted plaintext is returned.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">window</span><span class="p">.</span><span class="nv">Cryptobox.decrypt = </span><span class="nf">(pass, salt, ciphertext, iterations, keylen, iv) -&gt;</span>
  <span class="nv">secret = </span><span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">PBKDF2</span><span class="p">(</span>
    <span class="nx">pass</span><span class="p">,</span>
    <span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">enc</span><span class="p">.</span><span class="nx">Base64</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">salt</span><span class="p">),</span>
    <span class="p">{</span>
      <span class="nv">keySize: </span><span class="nx">keylen</span> <span class="o">/</span> <span class="mi">32</span><span class="p">,</span>
      <span class="nv">iterations: </span><span class="nx">iterations</span>
    <span class="p">})</span>

  <span class="nv">result = </span><span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">AES</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span>
    <span class="nx">ciphertext</span><span class="p">,</span>
    <span class="nx">secret</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="nv">mode: </span><span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">CBC</span><span class="p">,</span>
      <span class="nv">iv: </span><span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">enc</span><span class="p">.</span><span class="nx">Base64</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">iv</span><span class="p">),</span>
      <span class="nv">padding: </span><span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">pad</span><span class="p">.</span><span class="nx">Pkcs7</span>
    <span class="p">})</span>

  <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">enc</span><span class="p">.</span><span class="nx">Utf8</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Open a cryptobox using given <code>password</code> and execute <code>callback</code> when data has
been decrypted. This function uses embedded cryptobox.json (<code>Cryptobox.json</code>)
if available; otherwise it tries to read cryptobox.json from Dropbox.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">window</span><span class="p">.</span><span class="nv">Cryptobox.open = </span><span class="nf">(password, callback) -&gt;</span>
  <span class="nv">decrypt = </span><span class="nf">(json, callback) -&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>we need small timeout here because otherwise decryption
stuff will not let the UI to be redrawn</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">setTimeout</span> <span class="o">-&gt;</span>
      <span class="k">try</span>
        <span class="nv">data = </span><span class="nx">cryptobox</span><span class="p">.</span><span class="nx">measure</span> <span class="s">&#39;decrypt&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
          <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Cryptobox</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span>
            <span class="nx">json</span><span class="p">.</span><span class="nx">pbkdf2</span><span class="p">.</span><span class="nx">salt</span><span class="p">,</span>
            <span class="nx">json</span><span class="p">.</span><span class="nx">ciphertext</span><span class="p">,</span>
            <span class="nx">json</span><span class="p">.</span><span class="nx">pbkdf2</span><span class="p">.</span><span class="nx">iterations</span><span class="p">,</span>
            <span class="nx">json</span><span class="p">.</span><span class="nx">aes</span><span class="p">.</span><span class="nx">keylen</span><span class="p">,</span>
            <span class="nx">json</span><span class="p">.</span><span class="nx">aes</span><span class="p">.</span><span class="nx">iv</span><span class="p">))</span>

        <span class="nx">callback</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s">&quot;&lt;%= @text[:incorrect_password] %&gt; </span><span class="si">#{</span><span class="nx">e</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="p">,</span> <span class="mi">10</span>

  <span class="k">if</span> <span class="nx">cryptobox</span><span class="p">.</span><span class="nx">json</span>
    <span class="nx">decrypt</span><span class="p">(</span><span class="nx">cryptobox</span><span class="p">.</span><span class="nx">json</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nx">cryptobox</span><span class="p">.</span><span class="nx">dropbox</span><span class="p">.</span><span class="nx">read</span> <span class="nf">(error, data) -&gt;</span>
      <span class="k">if</span> <span class="nx">error</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s">&quot;Can&#39;t read file &#39;cryptobox.json (</span><span class="si">#{</span><span class="nx">error</span><span class="si">}</span><span class="s">)&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

      <span class="nx">decrypt</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="nx">callback</span><span class="p">)</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
